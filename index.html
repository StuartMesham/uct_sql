<!doctype html>
<html lang="en">
<head>
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>SQL Practice</title>
    <link href="main.css" rel="stylesheet">
</head>
<body>
<div id="lesson-name"></div>
<div id="prompt"></div>
<div id='current-tables'></div>
<div id="editor"></div>
<div>
    <button onclick="execute_query()">Run (ctrl/cmd-enter)</button>
</div>
<div id="results"></div>

<script src="node_modules/sql.js/dist/sql-asm.js"></script>
<script charset="utf-8" src="node_modules/ace-builds/src-min-noconflict/ace.js" type="text/javascript"></script>
<script charset="utf-8" src="node_modules/ace-builds/src-min-noconflict/ext-language_tools.js" type="text/javascript"></script>
<script charset="utf-8" src="ace-mode-sqlcaps.js" type="text/javascript"></script>
<script>

    let execute_query = function () {
        try {
            var results = db.exec(editor.getValue());
            if (results.length === 0) {
                document.getElementById("results").innerHTML = '<div class="table-container">no rows returned</div>';
            } else {
                document.getElementById("results").innerHTML = '<div class="table-container">' + table_from_results(results) + "</div>";
            }
        } catch (err) {
            document.getElementById("results").innerHTML = err;
        }
        // scroll to bottom so mobile users see the result
        window.scrollTo(0, document.body.scrollHeight);
    };


    // code editor setup
    let editor = ace.edit("editor", {
        mode: "ace/mode/sqlcaps",
        theme: ((window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? "ace/theme/monokai" : "ace/theme/crimson_editor"),
        enableBasicAutocompletion: true,
        enableSnippets: true,
        enableLiveAutocompletion: true,
        maxLines: Infinity,
    });

    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        editor.setTheme("ace/theme/monokai");
    } else {
        editor.setTheme("ace/theme/crimson_editor");
    }

    if (window.matchMedia) {
        window.matchMedia('(prefers-color-scheme: dark)')
            .addEventListener('change', event => {
                if (event.matches) {
                    editor.setTheme("ace/theme/monokai");
                } else {
                    editor.setTheme("ace/theme/crimson_editor");
                }
            })
    }


    editor.commands.addCommand({
        name: "execute",
        bindKey: {mac: "cmd-return", win: "ctrl-return"},
        exec: execute_query
    });

    var sql;
    // The db variable gets set every time a level is loaded.
    var db;

    // Return an HTML table as a string, given SQL.js results
    var table_from_results = function (res) {
        var table_string = '<table>';
        if (res) {
            table_string += '<tr>';
            for (var index in res[0].columns) {
                table_string += '<th>' + res[0].columns[index] + '</th>';
            }
            table_string += '</tr>';
            for (var row_index in res[0].values) {
                table_string += '<tr>';
                for (var col_index in res[0].values[row_index]) {
                    table_string += '<td>' + res[0].values[row_index][col_index] + '</td>';
                }
                table_string += '</tr>';
            }
        }
        table_string += '</table>';
        return table_string;
    };

    var table_names, column_names;


    // Create the SQL database
    var load_database = function (db_type) {
        var database, sqlstr;
        database = new sql.Database();
        switch (db_type) {
            case 'family':
                sqlstr = "CREATE TABLE family_members (id int, name char, gender char, species char, num_books_read int);";
                sqlstr += "INSERT INTO family_members VALUES (1, 'Dave', 'male', 'human', 200);";
                sqlstr += "INSERT INTO family_members VALUES (2, 'Mary', 'female', 'human', 180);";
                sqlstr += "INSERT INTO family_members VALUES (3, 'Pickles', 'male', 'dog', 0);";
                table_names = ['family_members'];
                column_names = ['id, name, gender, species, num_books_read'];
                break;
            case 'friends_of_pickles':
                sqlstr = "CREATE TABLE friends_of_pickles (id int, name char, gender char, species char, height_cm int);";
                sqlstr += "INSERT INTO friends_of_pickles VALUES (1, 'Dave', 'male', 'human', 180);";
                sqlstr += "INSERT INTO friends_of_pickles VALUES (2, 'Mary', 'female', 'human', 160);";
                sqlstr += "INSERT INTO friends_of_pickles VALUES (3, 'Fry', 'male', 'cat', 30);";
                sqlstr += "INSERT INTO friends_of_pickles VALUES (4, 'Leela', 'female', 'cat', 25);";
                sqlstr += "INSERT INTO friends_of_pickles VALUES (5, 'Odie', 'male', 'dog', 40);";
                sqlstr += "INSERT INTO friends_of_pickles VALUES (6, 'Jumpy', 'male', 'dog', 35);";
                sqlstr += "INSERT INTO friends_of_pickles VALUES (7, 'Sneakers', 'male', 'dog', 55);";
                table_names = ['friends_of_pickles'];
                break;
            case 'family_and_legs':
                sqlstr = "CREATE TABLE family_members (id int, name char, species char, num_books_read int, num_legs int);";
                sqlstr += "INSERT INTO family_members VALUES (1, 'Dave', 'human', 200, 2);";
                sqlstr += "INSERT INTO family_members VALUES (2, 'Mary', 'human', 180, 2);";
                sqlstr += "INSERT INTO family_members VALUES (3, 'Pickles', 'dog', 0, 4);";
                table_names = ['family_members'];
                break;
            case 'family_null':
                sqlstr = "CREATE TABLE family_members (id int, name char, gender char, species char, favorite_book char);";
                sqlstr += "INSERT INTO family_members VALUES (1, 'Dave', 'male', 'human', 'To Kill a Mockingbird');";
                sqlstr += "INSERT INTO family_members VALUES (2, 'Mary', 'female', 'human', 'Gone with the Wind');";
                sqlstr += "INSERT INTO family_members VALUES (3, 'Pickles', 'male', 'dog', NULL);";
                table_names = ['family_members'];
                break;
            case 'celebs_born':
                sqlstr = "CREATE TABLE celebs_born (id int, name char, birthdate date);";
                sqlstr += "INSERT INTO celebs_born VALUES (1, 'Michael Jordan', '1963-02-17');";
                sqlstr += "INSERT INTO celebs_born VALUES (2, 'Justin Timberlake', '1981-01-31');";
                sqlstr += "INSERT INTO celebs_born VALUES (3, 'Taylor Swift', '1989-12-13');";
                table_names = ['celebs_born'];
                break;
            case 'tv':
                sqlstr = "CREATE TABLE character (id int, name char);";
                sqlstr += "INSERT INTO character VALUES (1, 'Doogie Howser');";
                sqlstr += "INSERT INTO character VALUES (2, 'Barney Stinson');";
                sqlstr += "INSERT INTO character VALUES (3, 'Lily Aldrin');";
                sqlstr += "INSERT INTO character VALUES (4, 'Willow Rosenberg');";
                sqlstr += "CREATE TABLE character_tv_show (id int, character_id int, tv_show_name char);";
                sqlstr += "INSERT INTO character_tv_show VALUES (1, 4, 'Buffy the Vampire Slayer');";
                sqlstr += "INSERT INTO character_tv_show VALUES (2, 3, 'How I Met Your Mother');";
                sqlstr += "INSERT INTO character_tv_show VALUES (3, 2, 'How I Met Your Mother');";
                sqlstr += "INSERT INTO character_tv_show VALUES (4, 1, 'Doogie Howser, M.D.');";
                sqlstr += "CREATE TABLE character_actor (id int, character_id int, actor_name char);";
                sqlstr += "INSERT INTO character_actor VALUES (1, 4, 'Alyson Hannigan');";
                sqlstr += "INSERT INTO character_actor VALUES (2, 3, 'Alyson Hannigan');";
                sqlstr += "INSERT INTO character_actor VALUES (3, 2, 'Neil Patrick Harris');";
                sqlstr += "INSERT INTO character_actor VALUES (4, 1, 'Neil Patrick Harris');";
                table_names = ['character', 'character_tv_show', 'character_actor'];
                column_names = ['id', 'name', 'character_id', 'tv_show_id', 'tv_show_name', 'actor_name', 'actor_id'];
                break;
            case 'tv_normalized':
                sqlstr = "CREATE TABLE character (id int, name char);";
                sqlstr += "INSERT INTO character VALUES (1, 'Doogie Howser');";
                sqlstr += "INSERT INTO character VALUES (2, 'Barney Stinson');";
                sqlstr += "INSERT INTO character VALUES (3, 'Lily Aldrin');";
                sqlstr += "INSERT INTO character VALUES (4, 'Willow Rosenberg');";
                sqlstr += "CREATE TABLE tv_show (id int, name char);";
                sqlstr += "INSERT INTO tv_show VALUES (1, 'Buffy the Vampire Slayer');";
                sqlstr += "INSERT INTO tv_show VALUES (2, 'How I Met Your Mother');";
                sqlstr += "INSERT INTO tv_show VALUES (3, 'Doogie Howser, M.D.');";
                sqlstr += "CREATE TABLE character_tv_show (id int, character_id int, tv_show_id int);";
                sqlstr += "INSERT INTO character_tv_show VALUES (1, 1, 3);";
                sqlstr += "INSERT INTO character_tv_show VALUES (2, 2, 2);";
                sqlstr += "INSERT INTO character_tv_show VALUES (3, 3, 2);";
                sqlstr += "INSERT INTO character_tv_show VALUES (4, 4, 1);";
                sqlstr += "CREATE TABLE actor (id int, name char);";
                sqlstr += "INSERT INTO actor VALUES (1, 'Alyson Hannigan');";
                sqlstr += "INSERT INTO actor VALUES (2, 'Neil Patrick Harris');";
                sqlstr += "CREATE TABLE character_actor (id int, character_id int, actor_id int);";
                sqlstr += "INSERT INTO character_actor VALUES (1, 1, 2);";
                sqlstr += "INSERT INTO character_actor VALUES (2, 2, 2);";
                sqlstr += "INSERT INTO character_actor VALUES (3, 3, 1);";
                sqlstr += "INSERT INTO character_actor VALUES (4, 4, 1);";
                table_names = ['character', 'tv_show', 'character_tv_show', 'actor', 'character_actor'];
                break;
            case 'tv_extra':
                sqlstr = "CREATE TABLE character (id int, name char);";
                sqlstr += "INSERT INTO character VALUES (1, 'Doogie Howser');";
                sqlstr += "INSERT INTO character VALUES (2, 'Barney Stinson');";
                sqlstr += "INSERT INTO character VALUES (3, 'Lily Aldrin');";
                sqlstr += "INSERT INTO character VALUES (4, 'Willow Rosenberg');";
                sqlstr += "INSERT INTO character VALUES (5, 'Steve Urkel');";
                sqlstr += "INSERT INTO character VALUES (6, 'Homer Simpson');";
                sqlstr += "CREATE TABLE tv_show (id int, name char);";
                sqlstr += "INSERT INTO tv_show VALUES (1, 'Buffy the Vampire Slayer');";
                sqlstr += "INSERT INTO tv_show VALUES (2, 'How I Met Your Mother');";
                sqlstr += "INSERT INTO tv_show VALUES (3, 'Doogie Howser, M.D.');";
                sqlstr += "INSERT INTO tv_show VALUES (4, 'Friends');";
                sqlstr += "CREATE TABLE character_tv_show (id int, character_id int, tv_show_id int);";
                sqlstr += "INSERT INTO character_tv_show VALUES (1, 1, 3);";
                sqlstr += "INSERT INTO character_tv_show VALUES (2, 2, 2);";
                sqlstr += "INSERT INTO character_tv_show VALUES (3, 3, 2);";
                sqlstr += "INSERT INTO character_tv_show VALUES (4, 4, 1);";
                sqlstr += "CREATE TABLE actor (id int, name char);";
                sqlstr += "INSERT INTO actor VALUES (1, 'Alyson Hannigan');";
                sqlstr += "INSERT INTO actor VALUES (2, 'Neil Patrick Harris');";
                sqlstr += "INSERT INTO actor VALUES (3, 'Adam Sandler');";
                sqlstr += "INSERT INTO actor VALUES (4, 'Steve Carell');";
                sqlstr += "CREATE TABLE character_actor (id int, character_id int, actor_id int);";
                sqlstr += "INSERT INTO character_actor VALUES (1, 1, 2);";
                sqlstr += "INSERT INTO character_actor VALUES (2, 2, 2);";
                sqlstr += "INSERT INTO character_actor VALUES (3, 3, 1);";
                sqlstr += "INSERT INTO character_actor VALUES (4, 4, 1);";
                table_names = ['character', 'tv_show', 'character_tv_show', 'actor', 'character_actor'];
                column_names = ['id', 'name', 'character_id', 'tv_show_id', 'tv_show_name', 'actor_name', 'actor_id'];
                break;
            case 'self_join':
                sqlstr = "CREATE TABLE rps (id int, name char, defeats_id int);";
                sqlstr += "INSERT INTO rps VALUES (1, 'Rock', 3);";
                sqlstr += "INSERT INTO rps VALUES (2, 'Paper', 1);";
                sqlstr += "INSERT INTO rps VALUES (3, 'Scissors', 2);";
                sqlstr += "CREATE TABLE employees (id int, name char, title char, boss_id int);";
                sqlstr += "INSERT INTO employees VALUES (1, 'Patrick Smith', 'Software Engineer', 2);";
                sqlstr += "INSERT INTO employees VALUES (2, 'Abigail Reed', 'Engineering Manager', 3);";
                sqlstr += "INSERT INTO employees VALUES (3, 'Bob Carey', 'Director of Engineering', 4);";
                sqlstr += "INSERT INTO employees VALUES (4, 'Maxine Tang', 'CEO', null);";
                table_names = ['rps', 'employees'];
                break;
            case 'robot':
                sqlstr = "CREATE TABLE robots (id int, name char);";
                sqlstr += "INSERT INTO robots VALUES (1, 'Robot 2000');";
                sqlstr += "INSERT INTO robots VALUES (2, 'Champion Robot 2001');";
                sqlstr += "INSERT INTO robots VALUES (3, 'Dragon');";
                sqlstr += "INSERT INTO robots VALUES (4, 'Turbo Robot 2002');";
                sqlstr += "INSERT INTO robots VALUES (5, 'Super Robot 2003');";
                sqlstr += "INSERT INTO robots VALUES (6, 'Super Turbo Robot 2004');";
                sqlstr += "INSERT INTO robots VALUES (7, 'Not A Robot');";
                sqlstr += "INSERT INTO robots VALUES (8, 'Unreleased Turbo Robot 2111');";
                table_names = ['robots'];
                break;
            case 'robot_code':
                sqlstr = "CREATE TABLE robots (id int, name char, location char);";
                sqlstr += "INSERT INTO robots VALUES (1, 'R2000 - Robot 2000', 'New City, NY');";
                sqlstr += "INSERT INTO robots VALUES (2, 'R2001 - Champion Robot 2001', 'Palo Alto, CA');";
                sqlstr += "INSERT INTO robots VALUES (3, 'D0001 - Dragon', 'New York City, NY');";
                sqlstr += "INSERT INTO robots VALUES (4, 'R2002 - Turbo Robot 2002', 'Spring Valley, NY');";
                sqlstr += "INSERT INTO robots VALUES (5, 'R2003 - Super Robot 2003', 'Nyack, NY');";
                sqlstr += "INSERT INTO robots VALUES (6, 'R2004 - Super Turbo Robot 2004', 'Tampa, FL');";
                sqlstr += "INSERT INTO robots VALUES (7, 'N0001 - Not A Robot', 'Seattle, WA');";
                sqlstr += "INSERT INTO robots VALUES (8, 'U2111 - Unreleased Turbo Robot 2111', 'Buffalo, NY');";
                table_names = ['robots'];
                break;
            case 'fighting':
                sqlstr = "CREATE TABLE fighters (id int, name char, gun char, sword char, tank char);";
                sqlstr += "INSERT INTO fighters VALUES (1, 'US Marine', 'Colt 9mm SMG', 'Swiss Army Knife', 'M1A1 Abrams Tank');";
                sqlstr += "INSERT INTO fighters VALUES (2, 'John Wilkes Booth', '.44 caliber Derringer', null, null);";
                sqlstr += "INSERT INTO fighters VALUES (3, 'Zorro', null, 'Sword of Zorro', null);";
                sqlstr += "INSERT INTO fighters VALUES (4, 'Innocent Bystander', null, null, null);";
                table_names = ['fighters'];
                break;
        }

        database.run(sqlstr);

        var current_table_string = '';
        for (var index in table_names) {
            results = database.exec("SELECT * FROM " + table_names[index] + ";");
            current_table_string += '<div class="table-container"><div class="table-name">' + table_names[index] + '</div>' + table_from_results(results) + '</div>';
        }
        document.getElementById("current-tables").innerHTML = current_table_string;

        return database;
    };

    var initSqlJs = window.initSqlJs;
    initSqlJs({
        // Required to load the wasm binary asynchronously. Of course, you can host it wherever you want
        // You can omit locateFile completely when running in node
        locateFile: file => `node_modules/sql.js/dist/${file}`
    }).then(function (SQL) {

        sql = SQL;

    db = load_database('tv_extra');

    // fetch ace's language tools module:
    var langTools = ace.require('ace/ext/language_tools');

    let autocompleteValues = table_names.map(table_name => {
        return {
            value: table_name,
            meta: "Table",
            score: 100,
        }
    }).concat(
        column_names.map(column_name => {
            return {
                value: column_name,
                meta: "Column",
                score: 0,
            }
        })
    );

    // create a completer object with a required callback function:
    var sqlTablesCompleter = {
        getCompletions: function (editor, session, pos, prefix, callback) {
            callback(null, autocompleteValues);
        }
    };
    // finally, bind to langTools:
    langTools.addCompleter(sqlTablesCompleter);
    });


</script>
</body>
</html>
